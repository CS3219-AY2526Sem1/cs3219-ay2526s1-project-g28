name: CI + CD (execution-service)

on:
  push:
    branches:
      - master
  workflow_dispatch: {} # allow manual trigger too

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  execution-service:
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Build Docker image (for local health check)
      - name: Build image
        run: |
          NS="${{ secrets.DOCKER_HUB_USERNAME }}"
          docker build -t "$NS/execution-service:dev" \
            -f backend/execution-service/Dockerfile \
            backend/execution-service

      # Run container for health check
      - name: Run execution-service container
        run: |
          NS="${{ secrets.DOCKER_HUB_USERNAME }}"
          docker run -d --name execution-service \
            -p 3006:3006 \
            $(echo "${{ steps.sm.outputs.DOTENV }}" | grep '=' | cut -d'=' -f1 | sed 's/^/-e /' | tr '\n' ' ') \
            "$NS/execution-service:dev"

      - name: Health check
        run: |
          for i in {1..40}; do
            docker ps -a --filter "name=execution-service" --format 'table {{.Names}}\t{{.Status}}'
            if ! docker ps --format '{{.Names}}' | grep -q '^execution-service$'; then
              echo "Container exited"
              docker logs --timestamps --tail=200 execution-service || true
              exit 1
            fi
            if curl -fsS http://127.0.0.1:3006/health >/dev/null; then
              echo "✅ /health OK"
              exit 0
            fi
            echo "waiting for /health... ($i)"; sleep 1
          done
          echo "❌ health never came up"
          docker logs execution-service || true
          exit 1

      - name: Install dependencies
        working-directory: backend/execution-service
        run: npm ci --omit=dev

      # Deploy to AWS Lambda with Serverless
      - name: Deploy to AWS Lambda
        working-directory: backend/execution-service
        run: |
          npm install -g serverless@3
          npx serverless deploy --stage prod --region ap-southeast-1
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_XZ }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_XZ }}

      # Logs (always show)
      - name: Logs (always)
        if: always()
        run: |
          echo "----- execution-service logs -----"
          docker logs --timestamps --tail=150 execution-service || true

      # Cleanup
      - name: Cleanup
        if: always()
        run: |
          docker rm -f execution-service || true
