# .github/workflows/user-health.yml
name: User Service Healthcheck

on:
  push:
    paths:
      - "backend/user-service/**"
      - ".github/workflows/user-health.yml"
  pull_request:
    paths:
      - "backend/user-service/**"

permissions:
  contents: read
  id-token: write   # if you later use GCP OIDC

jobs:
  user-health:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Sanity check paths
        run: |
          ls -la backend/user-service
          test -f backend/user-service/Dockerfile

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # IMPORTANT: --load so docker run can see the image
      - name: Build image (no push)
        run: |
          docker buildx build \
            --platform=linux/amd64 \
            --load \
            -t local/user-service:ci \
            -f backend/user-service/Dockerfile \
            backend/user-service

      - name: Show images
        run: docker images | grep user-service || true

      # If your /health doesn't need DB, you can run straight away.
      # If it DOES need DB, uncomment the Mongo service block below.
      - name: Run container
        run: |
          docker run -d --rm \
            -p 3001:3001 \
            --name user-service \
            -e NODE_ENV=production \
            local/user-service:ci
          for i in {1..30}; do
            curl -fsS http://127.0.0.1:3001/health && break
            echo "waiting for /health... ($i)"
            sleep 1
          done

      - name: Health check
        run: curl -v http://127.0.0.1:3001/health

      - name: Logs if failed
        if: failure()
        run: docker logs user-service || true

      - name: Teardown
        if: always()
        run: docker stop user-service || true
