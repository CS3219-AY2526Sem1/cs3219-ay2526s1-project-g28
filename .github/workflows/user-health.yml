name: Build & Health (user-service)

on:
  pull_request:
  push:
    branches: ["**"]

permissions:
  contents: read

jobs:
  user-service:
    runs-on: ubuntu-latest
    env:
      # Safe default; falls back to repo owner if no DockerHub username
      NS: ${{ secrets.DOCKER_HUB_USERNAME || github.repository_owner }}

    steps:
      - uses: actions/checkout@v4

      - name: Fail if NS empty (clear error)
        run: ': "${NS:?Set DOCKER_HUB_USERNAME secret or use repo owner default}"'

      - name: Build image
        run: |
          docker build -t "$NS/user-service:dev" \
            -f backend/user-service/Dockerfile \
            backend/user-service

      # Only fetch secrets on trusted contexts (not fork PRs)
      - name: Auth to Google with key
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - id: sm
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |
            projects/${{ secrets.GCP_PROJECT_ID }}/secrets/user-service-env/versions/latest:DOTENV

      - name: Write & normalize .env + CI flags
        # Skip if secrets weren’t fetched (e.g., fork PR). Guard on output existence.
        if: steps.sm.outputs.DOTENV != ''
        run: |
          printf '%s' "${{ steps.sm.outputs.DOTENV }}" > user-service.env
          sed -i 's/\r$//' user-service.env
          sed -i 's/[[:space:]]*$//' user-service.env
          grep -q '^PORT=' user-service.env || echo 'PORT=3001' >> user-service.env
          grep -q '^HOST=' user-service.env || echo 'HOST=0.0.0.0' >> user-service.env
          grep -q '^SESSION_SECRET=' user-service.env || echo 'SESSION_SECRET=ci-session-secret' >> user-service.env
          if ! grep -q '^MONGO_URI=' user-service.env; then
            if grep -q '^DB_LOCAL_URI=' user-service.env; then
              echo "MONGO_URI=$(grep '^DB_LOCAL_URI=' user-service.env | cut -d= -f2-)" >> user-service.env
            elif grep -q '^DB_CLOUD_URI=' user-service.env; then
              echo "MONGO_URI=$(grep '^DB_CLOUD_URI=' user-service.env | cut -d= -f2-)" >> user-service.env
            else
              echo 'MONGO_URI=mongodb://host.docker.internal:27017/test' >> user-service.env
            fi
          fi

      - name: Start Mongo if needed
        if: steps.sm.outputs.DOTENV != ''
        run: |
          if grep -q '^MONGO_URI=mongodb://host.docker.internal' user-service.env; then
            docker run -d --name mongo -p 27017:27017 mongo:7
            for i in {1..40}; do
              docker exec mongo mongosh --quiet --eval "db.adminCommand({ ping: 1 })" && break
              echo "waiting for Mongo... ($i)"; sleep 1
            done
          else
            echo "External DB configured; not starting local Mongo."
          fi

      - name: Run user-service
        # If no .env (fork PR), still run with minimal env so container can start
        run: |
          if [ -f user-service.env ]; then
            ENVFILE="--env-file ./user-service.env"
          else
            printf 'PORT=3001\nHOST=0.0.0.0\nDISABLE_OAUTH=true\n' > minimal.env
            ENVFILE="--env-file ./minimal.env"
          fi
          docker run -d --name user-service -p 3001:3001 $ENVFILE "$NS/user-service:dev"

      - name: Confirm env inside container
        run: |
          for k in PORT HOST MONGO_URI DISABLE_OAUTH GOOGLE_CLIENT_ID GOOGLE_CLIENT_SECRET GOOGLE_CALLBACK_URL SESSION_SECRET; do
            docker exec user-service sh -lc "v=\${$k}; [ -n \"\$v\" ] && echo $k len:\${#v} || echo $k MISSING"
          done

      - name: Wait for /health
        run: |
          for i in {1..40}; do
            if ! docker ps --format '{{.Names}}' | grep -q '^user-service$'; then
              echo "Container exited"; docker logs --timestamps --tail=200 user-service || true
              echo "Exit code: $(docker inspect user-service --format='{{.State.ExitCode}}' || true)"; exit 1
            fi
            curl -fsS http://127.0.0.1:3001/health && { echo "✅ /health OK"; exit 0; }
            echo "waiting for /health... ($i)"; sleep 1
          done
          echo "❌ health never came up"; docker logs user-service || true; exit 1

      - name: Logs (always)
        if: always()
        run: |
          echo "----- user-service logs -----"
          docker logs --timestamps --tail=150 user-service || true
          echo "----- mongo logs -----"
          docker logs --timestamps --tail=80 mongo || true

      - name: Cleanup
        if: always()
        run: |
          docker rm -f user-service || true
          docker rm -f mongo || true
