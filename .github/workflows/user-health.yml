name: User Service - Health Check

on:
  pull_request:
    paths: ["services/user/**", ".github/workflows/user-health.yml"]
  push:
    branches: [master, CI]
    paths: ["services/user/**", ".github/workflows/user-health.yml"]

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 1) Simple auth with SA JSON key stored in GitHub Secrets
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      # 2) Pull the .env blob from Google Secret Manager
      - id: gsm
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |
            USER_SERVICE_ENV: projects/${{ secrets.GCP_PROJECT_ID }}/secrets/user-service-env/versions/latest

      # 3) Write .env for the container and mask it in logs
      - name: Write .env
        working-directory: services/user
        shell: bash
        run: |
          printf "%s" "${{ steps.gsm.outputs.USER_SERVICE_ENV }}" > .env
          while IFS= read -r line; do
            [ -n "$line" ] && echo "::add-mask::$line"
          done < .env

      # 4) Build image from services/user/Dockerfile
      - name: Build Docker image
        run: |
          docker build -t user-service:ci -f services/user/Dockerfile services/user

      # 5) Run container and probe /health (up to ~60s)
      - name: Run & health probe
        shell: bash
        run: |
          docker run -d --rm --name user-service \
            --env-file services/user/.env \
            -p 3001:3001 user-service:ci

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:3001/health >/dev/null; then
              echo "✅ Health OK"
              break
            fi
            echo "waiting for health... ($i/30)"
            sleep 2
            if [ $i -eq 30 ]; then
              echo "❌ Health check failed"
              docker logs user-service || true
              exit 1
            fi
          done

          docker logs --tail=200 user-service || true
          docker stop user-service
