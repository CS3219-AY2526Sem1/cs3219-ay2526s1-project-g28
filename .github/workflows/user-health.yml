name: User Service Healthcheck

on:
  push:
    paths:
      - "backend/user-service/**"
      - ".github/workflows/user-health.yml"
  pull_request:
    paths:
      - "backend/user-service/**"

permissions:
  contents: read

jobs:
  user-health:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check repo paths
        run: |
          ls -la
          test -d backend/user-service && echo "Found backend/user-service" || (echo "Missing backend/user-service" && exit 1)
          test -f backend/user-service/Dockerfile || (echo "Missing Dockerfile in backend/user-service" && exit 1)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (no push)
        run: |
          docker buildx build \
            -f backend/user-service/Dockerfile \
            -t local/user-service:ci \
            backend/user-service

      - name: Run container
        run: |
          docker run -d --rm \
            -p 3001:3001 \
            --name user-service \
            -e NODE_ENV=production \
            local/user-service:ci
          # wait for server to boot
          for i in {1..30}; do
            curl -fsS http://127.0.0.1:3001/health && break
            echo "waiting for /health... ($i)"
            sleep 1
          done

      - name: Health check
        run: |
          curl -v http://127.0.0.1:3001/health

      - name: Logs (if failed)
        if: failure()
        run: |
          echo "Container logs:"
          docker logs user-service || true

      - name: Teardown
        if: always()
        run: |
          docker ps -a
          docker stop user-service || true
