name: Test with Google Secret Manager env

on:
  pull_request:
  push:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      # 1) Auth to GCP with the JSON key stored in GitHub Secrets
      - name: Google Auth (simple)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      # 2) Fetch the .env blob from Secret Manager
      - id: gsm
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |
            USER_SERVICE_ENV: projects/${{ secrets.GCP_PROJECT_ID }}/secrets/user-service-env/versions/latest

      # 3) Write .env for your service and mask it
      - name: Write .env
        working-directory: backend/user-service
        shell: bash
        run: |
          printf "%s" "${{ steps.gsm.outputs.USER_SERVICE_ENV }}" > .env
          while IFS= read -r line; do
            [ -n "$line" ] && echo "::add-mask::$line"
          done < .env

      # 4) Install and run tests with env loaded
      - name: npm ci & test
        working-directory: backend/user-service
        shell: bash
        run: |
          npm ci
          # export all vars from .env into the shell so npm test sees them
          set -a; source .env; set +a
          npm test
