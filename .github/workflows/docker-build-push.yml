name: Build & Test Services (No Secrets)

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install and Test Each Service
        run: |
          echo "ğŸ” Checking all Node.js services"
          for dir in services/*; do
            if [ -f "$dir/package.json" ]; then
              echo "ğŸ“¦ Installing dependencies in $dir"
              cd "$dir"
              npm ci || npm install
              echo "ğŸš€ Building (if script exists)"
              npm run build --if-present
              echo "âœ… Running test or basic start check"
              npm run test --if-present || echo "No test script found"
              cd ../../
            fi
          done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Detect changed services
        id: changed
        run: |
          BASE_SHA="${{ github.event.before || github.event.pull_request.base.sha || 'HEAD~1' }}"
          HEAD_SHA="${{ github.sha }}"
          services=$(bash scripts/list_changed_services.sh "$BASE_SHA" "$HEAD_SHA" || true)
          echo "services<<EOF" >> $GITHUB_OUTPUT
          echo "${services}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed services:"
          echo "${services}"

      - name: Set image tag
        id: tag
        run: echo "value=$(bash scripts/image_tag.sh)" >> $GITHUB_OUTPUT

      - name: Build Docker Images (no secrets)
        if: steps.changed.outputs.services != ''
        run: |
          tag='${{ steps.tag.outputs.value }}'

          while read svc; do
            [ -z "$svc" ] && continue
            image="local/${svc}:${tag}"
            echo "ğŸ”§ Building $image from services/$svc"
            docker build -t "$image" "services/$svc"
          done <<< "${{ steps.changed.outputs.services }}"

      - name: List built images
        run: docker images
