name: Build and Publish images to Docker Hub

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  publish_images:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: Build images
        run: |
          NS="${{ secrets.DOCKER_HUB_USERNAME }}"  # or your org name if pushing to an org
          docker build -t "$NS/user-service:dev" -f ./backend/user-service/Dockerfile ./backend/user-service
          docker build -t "$NS/question-service:dev" -f ./backend/question-service/Dockerfile ./backend/question-service
          docker build -t "$NS/matching-service:dev" -f ./backend/matching-service/Dockerfile ./backend/matching-service
          docker build -t "$NS/collaboration-service:dev" -f ./backend/collaboration-service/Dockerfile ./backend/collaboration-service
          docker build -t "$NS/notification-service:dev" -f ./backend/notification-service/Dockerfile ./backend/notification-service
          docker build -t "$NS/execution-service:dev" -f ./backend/execution-service/Dockerfile ./backend/execution-service
          docker build -t "$NS/ai-service:dev" -f ./backend/ai-service/Dockerfile ./backend/ai-service
          docker build -t "$NS/api-gateway:dev" -f ./backend/api-gateway/Dockerfile ./backend/api-gateway
          docker build -t "$NS/frontend:dev" -f ./frontend/Dockerfile ./frontend

      - name: Push images
        run: |
          NS="${{ secrets.DOCKER_HUB_USERNAME }}"
          docker push "$NS/user-service:dev"
          docker push "$NS/question-service:dev"
          docker push "$NS/matching-service:dev"
          docker push "$NS/collaboration-service:dev"
          docker push "$NS/notification-service:dev"
          docker push "$NS/execution-service:dev"
          docker push "$NS/ai-service:dev"
          docker push "$NS/api-gateway:dev"
          docker push "$NS/frontend:dev"
