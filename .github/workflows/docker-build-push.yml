name: Build & Check Services (No Tests)

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install, Build, and Check Each Service
        run: |
          echo "üîç Checking all Node.js services"
          for dir in services/*; do
            if [ -f "$dir/package.json" ]; then
              echo "üì¶ Installing dependencies in $dir"
              cd "$dir"
              npm ci || npm install

              echo "üöÄ Building (if script exists)"
              npm run build --if-present

              echo "üß™ Starting service to verify it doesn't crash"
              # Prefer npm run dev, fallback to npm start
              if npm run dev --if-present & then
                pid=$!
                sleep 5
                if ps -p $pid > /dev/null; then
                  echo "‚úÖ $dir started successfully"
                  kill $pid
                else
                  echo "‚ùå $dir crashed during startup"
                  exit 1
                fi
              elif npm start & then
                pid=$!
                sleep 5
                if ps -p $pid > /dev/null; then
                  echo "‚úÖ $dir started successfully"
                  kill $pid
                else
                  echo "‚ùå $dir crashed during startup"
                  exit 1
                fi
              else
                echo "‚ö†Ô∏è No start/dev script found for $dir"
              fi

              cd ../../
            fi
          done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Detect changed services
        id: changed
        run: |
          BASE_SHA="${{ github.event.before || github.event.pull_request.base.sha || 'HEAD~1' }}"
          HEAD_SHA="${{ github.sha }}"
          services=$(bash scripts/list_changed_services.sh "$BASE_SHA" "$HEAD_SHA" || true)
          echo "services<<EOF" >> $GITHUB_OUTPUT
          echo "${services}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed services:"
          echo "${services}"

      - name: Set image tag
        id: tag
        run: echo "value=$(bash scripts/image_tag.sh)" >> $GITHUB_OUTPUT

      - name: Build Docker Images (no secrets)
        if: steps.changed.outputs.services != ''
        run: |
          tag='${{ steps.tag.outputs.value }}'

          while read svc; do
            [ -z "$svc" ] && continue
            image="local/${svc}:${tag}"
            echo "üîß Building $image from services/$svc"
            docker build -t "$image" "services/$svc"
          done <<< "${{ steps.changed.outputs.services }}"

      - name: Run built containers to check for crashes
        if: steps.changed.outputs.services != ''
        run: |
          tag='${{ steps.tag.outputs.value }}'

          while read svc; do
            [ -z "$svc" ] && continue
            image="local/${svc}:${tag}"
            echo "üß™ Running $image to ensure it doesn't crash"

            # Start the container in detached mode
            docker run -d --name "${svc}-check" "$image" || (echo "‚ùå Failed to start ${svc}" && exit 1)

            # Wait for startup
            sleep 10

            # Get container state
            exit_code=$(docker inspect "${svc}-check" --format='{{.State.ExitCode}}')
            status=$(docker inspect "${svc}-check" --format='{{.State.Status}}')

            if [ "$status" = "exited" ] && [ "$exit_code" != "0" ]; then
              echo "‚ùå ${svc} crashed (exit code $exit_code)"
              docker logs "${svc}-check" || true
              docker rm -f "${svc}-check" || true
              exit 1
            elif [ "$status" = "exited" ]; then
              echo "‚ö†Ô∏è ${svc} exited gracefully but did not stay running (check expected behavior)"
              docker logs "${svc}-check" || true
              docker rm -f "${svc}-check" || true
            else
              echo "‚úÖ ${svc} is running fine (no crash detected)"
              docker logs "${svc}-check" || true
              docker stop "${svc}-check" || true
              docker rm -f "${svc}-check" || true
            fi
          done <<< "${{ steps.changed.outputs.services }}"

      - name: List built images
        run: docker images
