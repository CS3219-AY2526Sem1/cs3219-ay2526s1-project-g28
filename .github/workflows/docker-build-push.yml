name: Build and Publish image to Docker Hub

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  publish_images:
    runs-on: ubuntu-latest
    environment: "Docker push and build images"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        run: |
          if [ -z "$DOCKER_HUB_USERNAME" ] || [ -z "$DOCKER_HUB_ACCESS_TOKEN" ]; then
            echo "‚ùå Missing Docker Hub credentials. Check your environment secrets."
            exit 1
          fi
          echo "$DOCKER_HUB_ACCESS_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
          echo "‚úÖ Logged in to Docker Hub as $DOCKER_HUB_USERNAME"

      - name: Build and Push image
        env:
          NS: ${{ secrets.DOCKER_HUB_USERNAME }}
        run: |
          set -e  # Stop on first error
          echo "üõ†Ô∏è  Building Docker image for user-service..."
          docker build -t "$NS/user-service:dev" -f ./backend/user-service/Dockerfile ./backend/user-service

          echo "üöÄ Pushing image to Docker Hub..."
          docker push "$NS/user-service:dev"
          echo "‚úÖ Image pushed successfully: $NS/user-service:dev"
